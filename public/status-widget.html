<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Status</title>
    <style>
        /* Base styles with dark mode support */
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background: transparent;
            color: #374151;
            font-size: 14px;
            line-height: 1.5;
        }

        /* Dark mode detection */
        @media (prefers-color-scheme: dark) {
            body { color: #d1d5db; background: #0c0910;}
            .title { color: #f9fafb !important; }
            .tab { color: #9ca3af !important; }
            .tab.active { color: #f9fafb !important; border-bottom-color: #f9fafb !important; }
            .tabs { border-bottom-color: #374151 !important; }
            .meta { color: #9ca3af !important; }
            .sep { border-top-color: #374151 !important; }
        }

        .wrap {
            padding: 20px 24px;
            max-width: 100%;
            min-height: auto;
            position: relative;
        }

        /* Enhanced tabs */
        .tabs {
            display: flex;
            gap: 2px;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 24px;
            background: #f9fafb;
            border-radius: 8px;
            padding: 4px;
        }

        .tab {
            padding: 10px 16px;
            cursor: pointer;
            background: none;
            border: none;
            font-weight: 500;
            color: #6b7280;
            border-radius: 6px;
            transition: all 0.2s ease;
            font-size: 14px;
            flex: 1;
            text-align: center;
        }

        .tab:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .tab.active {
            color: #ffffff;
            background: #aa00ff;
            font-weight: 600;
            box-shadow: 0 1px 3px 0 rgba(170, 0, 255, 0.3);
        }

        /* Enhanced cards */
        .card {
            margin: 20px 0;
            padding: 16px 20px;
            border-radius: 12px;
            background: #ffffff;
            border: 1px solid #f3f4f6;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease;
        }

        .card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform: translateY(-1px);
        }

        @media (prefers-color-scheme: dark) {
            .card {
                background: #1f2937;
                border-color: #374151;
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3);
            }
            .card:hover {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            }
            .tabs {
                background: #1f2937;
                border-color: #374151;
            }
            .tab:hover {
                background: #374151;
                color: #d1d5db;
            }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .title {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
            letter-spacing: -0.025em;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.05);
        }

        @media (prefers-color-scheme: dark) {
            .status { background: rgba(255, 255, 255, 0.1); }
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .bars {
            display: flex;
            gap: 2px;
            margin: 12px 0;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: inset 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .bar {
            height: 28px;
            flex: 1;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .bar:hover {
            transform: scaleY(1.1);
            z-index: 1;
        }

        .bar:first-child { border-radius: 4px 0 0 4px; }
        .bar:last-child { border-radius: 0 4px 4px 0; }
        .bar:only-child { border-radius: 4px; }

        .meta {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
        }

        .sep {
            border-top: 1px solid #e5e7eb;
            margin: 32px 0 24px;
        }

        .err {
            color: #dc2626;
            font-size: 14px;
            white-space: pre-wrap;
            background: #fef2f2;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #fecaca;
            font-weight: 500;
        }

        @media (prefers-color-scheme: dark) {
            .err {
                background: #7f1d1d;
                border-color: #b91c1c;
                color: #fecaca;
            }
        }

        .loading {
            color: #6b7280;
            font-size: 14px;
            text-align: center;
            padding: 32px;
            font-weight: 500;
        }

        /* Region headers */
        .region-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin: 24px 0 16px;
            padding: 0 4px;
        }

        .region-title {
            font-weight: 700;
            font-size: 16px;
            letter-spacing: 0.05em;
            color: #aa00ff;
            text-transform: uppercase;
        }

        .region-server {
            font-size: 12px;
            color: #9ca3af;
            font-weight: 500;
        }

        @media (prefers-color-scheme: dark) {
            .region-title { color: #c084fc; }
        }

        /* Responsive design */
        @media (max-width: 640px) {
            .wrap { padding: 16px; }
            .tabs { flex-direction: column; gap: 4px; }
            .tab { text-align: center; }
            .header { flex-direction: column; align-items: flex-start; gap: 8px; }
            .status { align-self: flex-end; }
            .meta { flex-direction: column; gap: 4px; text-align: center; }
        }

        /* Loading animation */
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 50%;
            border-top-color: #aa00ff;
            animation: spin 1s ease-in-out infinite;
            margin-left: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }


    </style>
</head>
<body>
<div class="wrap">
    <div class="tabs">
        <button id="tab-mainnet" class="tab active">Mainnet</button>
        <button id="tab-devnet" class="tab">Devnet</button>
    </div>

    <div id="loading" class="loading">Fetching statusâ€¦</div>
    <div id="error" class="err" style="display:none"></div>

    <div id="root" style="display:none">
        <div id="regions"></div>
    </div>

</div>

<script>
    const API_URL = "https://status.magicblock.app/api/services";
    let network = "mainnet";
    let cached = null;

    const $ = (id) => document.getElementById(id);

    const getBarColor = (m) => {
        if (m == null) return "rgba(156,163,175,.25)";
        if (m >= 5) return "#dc2626";
        if (m > 0) return "#ea580c";
        return "#16a34a";
    };

    const statusFromLast = (last) => {
        if (last == null) return { text:"N/A", dot:"#9ca3af", color:"#6b7280" };
        if (last >= 5) return { text:"Down", dot:"#ef4444", color:"#ef4444" };
        if (last > 0) return { text:"Degraded", dot:"#f97316", color:"#f97316" };
        return { text:"Operational", dot:"#22c55e", color:"#22c55e" };
    };

    const uptimePct = (arr) => {
        const valid = (arr||[]).filter(v => v != null);
        if (!valid.length) return null;
        const total = valid.length * 1440;
        const down = valid.reduce((s,v)=>s+v,0);
        return (((total - down) / total) * 100).toFixed(2);
    };

    const maxByDay = (arrays, len) => {
        const out = new Array(len).fill(null);
        for (let i=0;i<len;i++){
            let max=null;
            for (const a of arrays){
                const v = a?.[i];
                if (v==null) continue;
                if (max==null || v>max) max=v;
            }
            out[i]=max;
        }
        return out;
    };

    const clear = (node) => { while(node.firstChild) node.removeChild(node.firstChild); };

    const renderBar = (title, downtime, daysLabels) => {
        const card = document.createElement("div");
        card.className = "card";

        const last = downtime?.[downtime.length-1] ?? null;
        const st = statusFromLast(last);

        const header = document.createElement("div");
        header.className = "header";

        const t = document.createElement("div");
        t.className = "title";
        t.textContent = title;

        const s = document.createElement("div");
        s.className = "status";
        const dot = document.createElement("div");
        dot.className = "dot";
        dot.style.background = st.dot;
        const txt = document.createElement("span");
        txt.textContent = st.text;
        txt.style.color = st.color;

        s.appendChild(dot); s.appendChild(txt);
        header.appendChild(t); header.appendChild(s);

        const bars = document.createElement("div");
        bars.className = "bars";
        (downtime||[]).forEach((m,i)=>{
            const b = document.createElement("div");
            b.className = "bar";
            b.style.background = getBarColor(m);
            const d = daysLabels?.[i] ?? `Day ${i+1}`;
            b.title = `${d}: ${m==null ? "N/A" : m+" min"} downtime`;
            bars.appendChild(b);
        });

        const meta = document.createElement("div");
        meta.className = "meta";
        const left = document.createElement("span");
        left.textContent = `${(downtime||[]).length} days`;
        const mid = document.createElement("span");
        const up = uptimePct(downtime);
        mid.textContent = up==null ? "N/A uptime" : `${up}% uptime`;
        const right = document.createElement("span");
        right.textContent = "Today";
        meta.appendChild(left); meta.appendChild(mid); meta.appendChild(right);

        card.appendChild(header);
        card.appendChild(bars);
        card.appendChild(meta);
        return card;
    };

    const buildVM = (json, net) => {
        const days = json?.meta?.days ?? [];
        const regions = json?.environments?.[net]?.regions ?? {};

        const REGION_ORDER = [
            { key: "asia", title: "ASIA" },
            { key: "europe", title: "EUROPE" },
            { key: "usa", title: "USA" },
        ];

        const SERVICES = [
            { title: "Ephemeral Rollup (ER)", id: "er" },
            { title: "RPC Router", id: "rpc_router" },
            { title: "Pricing Oracle", id: "pricing_oracle" },
            { title: "VRF Oracle", id: "vrf_oracle" },
        ];

        const pickFirstServer = (regionKey) =>
            Object.keys(regions?.[regionKey]?.servers ?? {})[0] ?? null;

        const getMetric = (regionKey, fqdn, metricId) =>
            regions?.[regionKey]?.servers?.[fqdn]?.metrics?.[metricId] ?? null;

        const regionsVM = REGION_ORDER.map((r) => {
            const fqdn = pickFirstServer(r.key);
            const serverObj = fqdn ? regions?.[r.key]?.servers?.[fqdn] : null;

            const bars = SERVICES.map((svc) => {
                const arr = fqdn ? getMetric(r.key, fqdn, svc.id) : null;
                return {
                    title: svc.title,
                    downtime: arr ?? new Array(days.length).fill(null),
                };
            });

            return {
                key: r.key,
                title: r.title,
                serverFqdn: fqdn,
                displayName: serverObj?.displayName ?? fqdn ?? "N/A",
                bars,
            };
        });

        return { days, regions: regionsVM };
    };

    const setState = (loading, error) => {
        $("loading").style.display = loading ? "block" : "none";
        $("error").style.display = error ? "block" : "none";
        $("root").style.display = (!loading && !error) ? "block" : "none";
    };

    const showError = (msg) => {
        $("error").textContent = msg;
        setState(false, true);
    };

    const render = () => {
        if (!cached) return;
        const vm = buildVM(cached, network);

        const regionsRoot = $("regions");
        clear(regionsRoot);

        vm.regions.forEach((region) => {
            const section = document.createElement("div");

            const heading = document.createElement("div");
            heading.className = "region-header";

            const h = document.createElement("div");
            h.className = "region-title";
            h.textContent = region.title;

            /*const sub = document.createElement("div");
            sub.className = "region-server";
            sub.textContent = region.serverFqdn ? `${region.displayName}` : "no server";*/

            heading.appendChild(h);
            //heading.appendChild(sub);
            section.appendChild(heading);

            // Bars in the region
            region.bars.forEach((b) => {
                section.appendChild(renderBar(b.title, b.downtime, vm.days));
            });

            // divider (except for last region)
            const hr = document.createElement("div");
            hr.className = "sep";
            section.appendChild(hr);

            regionsRoot.appendChild(section);
        });

        setState(false, false);

        // Auto-resize iframe after render - try multiple methods
        setTimeout(() => {
            const height = Math.max(
                document.body.scrollHeight,
                document.body.offsetHeight,
                document.documentElement.clientHeight,
                document.documentElement.scrollHeight,
                document.documentElement.offsetHeight
            );

            // Try postMessage
            try {
                window.parent.postMessage({ type: 'resize', height }, '*');
            } catch (e) {
                console.log('PostMessage failed:', e);
            }

            // Also try direct manipulation if same origin
            try {
                if (window.parent && window.parent.document) {
                    const iframe = window.parent.document.getElementById('status-widget-iframe');
                    const container = window.parent.document.getElementById('status-widget-container');
                    if (iframe && container) {
                        iframe.style.height = height + 'px';
                        container.style.height = height + 'px';
                    }
                }
            } catch (e) {
                console.log('Direct manipulation failed:', e);
            }

            console.log('Widget height calculated:', height);
        }, 200);
    };

    const fetchData = async () => {
        setState(true, false);
        try {
            const r = await fetch(API_URL, { headers: { "Accept":"application/json" }, cache:"no-store" });
            const text = await r.text();
            if (!r.ok) throw new Error(`HTTP ${r.status}: ${text.slice(0,200)}`);
            cached = JSON.parse(text);
            render();
            // Additional resize attempt after data load
            setTimeout(() => {
                const height = Math.max(
                    document.body.scrollHeight,
                    document.documentElement.scrollHeight
                );
                window.parent.postMessage({ type: 'resize', height }, '*');
                console.log('Post-data-load height:', height);
            }, 300);
        } catch (e) {
            showError("Fetch error: " + (e?.message || String(e)));
        }
    };

    $("tab-mainnet").addEventListener("click", () => {
        network = "mainnet";
        $("tab-mainnet").classList.add("active");
        $("tab-devnet").classList.remove("active");
        if (cached) render();
    });
    $("tab-devnet").addEventListener("click", () => {
        network = "devnet";
        $("tab-devnet").classList.add("active");
        $("tab-mainnet").classList.remove("active");
        if (cached) render();
    });

    // Auto-resize iframe to content height
    const resizeIframe = () => {
        const height = document.body.scrollHeight;
        window.parent.postMessage({ type: 'resize', height }, '*');
    };

    // Also resize on window resize
    window.addEventListener('resize', () => {
        setTimeout(resizeIframe, 100);
    });

    fetchData();
</script>
</body>
</html>
